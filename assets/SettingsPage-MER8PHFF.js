import{a as z,r as n,j as e}from"./index-df1SZI71.js";import{M as F,N as L,O as M,P as T,Q as I}from"./api-x0wxRGLh.js";import{P as D}from"./PageHeading-CUjM0fdU.js";const J=r=>{try{return JSON.stringify(r??[],null,2)}catch{return"[]"}},k=(r,d)=>{try{return JSON.parse(r)}catch{return d}};function q(){var f,j,v,S,P,C;const{token:r}=z(),[d,p]=n.useState(!0),[h,m]=n.useState(!1),[g,c]=n.useState(""),[N,x]=n.useState(""),[a,o]=n.useState({institutionId:"",institutionName:"",currentAcademicYear:"",defaultTimezone:"",defaultLocale:"",campusesJson:"[]",academicYearsJson:"[]"}),[l,y]=n.useState({matrix:{},actorProfile:"",effectivePermissions:[]}),[i,Y]=n.useState(null),A=n.useMemo(()=>Object.keys(l.matrix||{}).sort(),[l.matrix]),b=async()=>{try{p(!0),c("");const[s,t,u]=await Promise.all([F(r),L(r),M(r)]);o({institutionId:s.institutionId||"",institutionName:s.institutionName||"",currentAcademicYear:s.currentAcademicYear||"",defaultTimezone:s.defaultTimezone||"",defaultLocale:s.defaultLocale||"",campusesJson:J(s.campuses||[]),academicYearsJson:J(s.academicYears||[])}),y({matrix:t.matrix||{},actorProfile:t.actorProfile||"",effectivePermissions:t.effectivePermissions||[]}),Y(u||null)}catch(s){c(s.message||"Failed to load enterprise settings.")}finally{p(!1)}};n.useEffect(()=>{b()},[r]);const O=async()=>{try{m(!0),c(""),x(""),await T(r,{institutionName:a.institutionName,currentAcademicYear:a.currentAcademicYear,defaultTimezone:a.defaultTimezone,defaultLocale:a.defaultLocale,campuses:k(a.campusesJson,[]),academicYears:k(a.academicYearsJson,[])}),x("System context updated."),await b()}catch(s){c(s.message||"Failed to update system context. Validate JSON fields.")}finally{m(!1)}},E=async()=>{try{m(!0),c(""),x(""),await I(r,{matrix:l.matrix}),x("Permission matrix updated."),await b()}catch(s){c(s.message||"Failed to update permission matrix. Super Admin access may be required.")}finally{m(!1)}};return e.jsxs("div",{className:"page-enter space-y-5 p-1",children:[e.jsx(D,{title:"Enterprise System Settings",subtitle:"Institution context, permission matrix, multi-campus readiness, localization, timezone, and observability."}),g?e.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:g}):null,N?e.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:N}):null,e.jsxs("section",{className:"panel-card space-y-4",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"System Context"}),d?e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-10"}),e.jsx("div",{className:"skeleton h-10"}),e.jsx("div",{className:"skeleton h-10"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsx("input",{value:a.institutionId,readOnly:!0,className:"rounded-sm border border-border bg-background px-3 py-2 text-sm"}),e.jsx("input",{value:a.institutionName,onChange:s=>o(t=>({...t,institutionName:s.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Institution name"}),e.jsx("input",{value:a.currentAcademicYear,onChange:s=>o(t=>({...t,currentAcademicYear:s.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Current academic year"}),e.jsx("input",{value:a.defaultTimezone,onChange:s=>o(t=>({...t,defaultTimezone:s.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Default timezone"}),e.jsx("input",{value:a.defaultLocale,onChange:s=>o(t=>({...t,defaultLocale:s.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Default locale"})]}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[e.jsxs("label",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs font-semibold text-text-secondary",children:"Campuses JSON"}),e.jsx("textarea",{value:a.campusesJson,onChange:s=>o(t=>({...t,campusesJson:s.target.value})),className:"focus-ring min-h-[160px] w-full rounded-sm border border-border px-3 py-2 text-xs"})]}),e.jsxs("label",{className:"space-y-1",children:[e.jsx("span",{className:"text-xs font-semibold text-text-secondary",children:"Academic Years JSON"}),e.jsx("textarea",{value:a.academicYearsJson,onChange:s=>o(t=>({...t,academicYearsJson:s.target.value})),className:"focus-ring min-h-[160px] w-full rounded-sm border border-border px-3 py-2 text-xs"})]})]}),e.jsx("button",{type:"button",className:"action-btn-primary",onClick:O,disabled:h,children:"Save System Context"})]})]}),e.jsxs("section",{className:"panel-card space-y-4",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Permission Matrix (RBAC)"}),d?e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-10"}),e.jsx("div",{className:"skeleton h-10"})]}):e.jsxs(e.Fragment,{children:[e.jsxs("p",{className:"text-xs text-text-secondary",children:["Your admin profile: ",l.actorProfile||"none"," | Effective permissions: ",l.effectivePermissions.length]}),e.jsx("div",{className:"space-y-2",children:A.map(s=>e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[e.jsx("p",{className:"text-sm font-semibold text-text-primary",children:s}),e.jsx("textarea",{value:(l.matrix[s]||[]).join(`
`),onChange:t=>y(u=>({...u,matrix:{...u.matrix,[s]:t.target.value.split(`
`).map(w=>w.trim()).filter(Boolean)}})),className:"focus-ring mt-2 min-h-[120px] w-full rounded-sm border border-border px-3 py-2 text-xs"})]},s))}),e.jsx("button",{type:"button",className:"action-btn-primary",onClick:E,disabled:h,children:"Save Permission Matrix"})]})]}),e.jsxs("section",{className:"panel-card space-y-3",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Observability Snapshot"}),d?e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-10"}),e.jsx("div",{className:"skeleton h-10"})]}):i?e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 text-sm",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:"Entities"}),e.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Students: ",Number(((f=i.entities)==null?void 0:f.students)||0)]}),e.jsxs("p",{className:"text-xs text-text-secondary",children:["Teachers: ",Number(((j=i.entities)==null?void 0:j.teachers)||0)]}),e.jsxs("p",{className:"text-xs text-text-secondary",children:["Classes: ",Number(((v=i.entities)==null?void 0:v.classes)||0)]}),e.jsxs("p",{className:"text-xs text-text-secondary",children:["Schedule entries: ",Number(((S=i.entities)==null?void 0:S.scheduleEntries)||0)]})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 text-sm",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:"Health"}),e.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Workload: ",((P=i.health)==null?void 0:P.workload)||"-"]}),e.jsx("p",{className:"text-xs text-text-secondary",children:((C=i.health)==null?void 0:C.recommendation)||"-"})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 text-sm",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:"Generated At"}),e.jsx("p",{className:"mt-1 text-xs text-text-secondary",children:i.generatedAt?new Date(i.generatedAt).toLocaleString("en-US"):"-"})]})]}):e.jsx("p",{className:"text-sm text-text-secondary",children:"No observability data available."})]})]})}export{q as default};
