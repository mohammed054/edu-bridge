import{a as R,r as a,j as t}from"./index-df1SZI71.js";import{y as B,z as F,A as O,B as _}from"./api-x0wxRGLh.js";import{P as U}from"./PageHeading-CUjM0fdU.js";const A=["open","pending","resolved"],E=["p1","p2","p3"],D={p1:"border-danger/35 bg-danger/10 text-danger",p2:"border-warning/35 bg-warning/10 text-warning",p3:"border-primary/35 bg-primary/10 text-primary"},M=(n,r)=>{const u=new Blob([n],{type:"text/csv;charset=utf-8"}),x=window.URL.createObjectURL(u),d=document.createElement("a");d.href=x,d.download=r,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(x)};function V(){var C;const{token:n}=R(),[r,u]=a.useState([]),[x,d]=a.useState([]),[L,y]=a.useState(!0),[p,j]=a.useState(""),[f,l]=a.useState(""),[N,S]=a.useState(""),[b,P]=a.useState(""),[g,$]=a.useState(""),[v,T]=a.useState(""),w=async()=>{try{y(!0),l("");const[e,s]=await Promise.all([B(n,{ticketStatus:b,priority:g}),F(n,{limit:400})]);u(e.rows||[]),d(s.feedbacks||[])}catch(e){l(e.message||"Failed to load ticket workflow."),u([]),d([])}finally{y(!1)}};a.useEffect(()=>{w()},[n,b,g]);const h=a.useMemo(()=>{const e=r.filter(o=>o.ticketStatus!=="resolved").length,s=r.filter(o=>o.workflowStatus==="escalated").length,k=r.filter(o=>o.slaBreached).length;return{backlog:e,escalated:s,slaBreached:k}},[r]),c=a.useMemo(()=>r.find(e=>e.id===v)||null,[r,v]),i=a.useMemo(()=>c&&x.find(e=>String(e._id||e.id)===String(c.id))||null,[x,c]),m=async(e,s,k)=>{try{j(e),l(""),S(""),await O(n,e,s),S(k||"Ticket updated."),await w()}catch(o){l(o.message||"Failed to update ticket.")}finally{j("")}},I=async()=>{try{l("");const e=await _(n);M(e,`ticket-workflow-${new Date().toISOString().slice(0,10)}.csv`)}catch(e){l(e.message||"Failed to export ticket workflow.")}};return t.jsxs("div",{className:"page-enter space-y-5 p-1",children:[t.jsx(U,{title:"Feedback Ticket Management",subtitle:"Ticket lifecycle states, SLA tracking, escalation controls, and analytics-oriented triage."}),f?t.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:f}):null,N?t.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:N}):null,t.jsxs("section",{className:"panel-card",children:[t.jsxs("div",{className:"grid gap-3 md:grid-cols-5",children:[t.jsxs("select",{value:b,onChange:e=>P(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"All statuses"}),A.map(e=>t.jsx("option",{value:e,children:e},e))]}),t.jsxs("select",{value:g,onChange:e=>$(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[t.jsx("option",{value:"",children:"All priorities"}),E.map(e=>t.jsx("option",{value:e,children:e},e))]}),t.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm text-text-secondary",children:["Backlog: ",h.backlog]}),t.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm text-text-secondary",children:["Escalated: ",h.escalated]}),t.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm text-text-secondary",children:["SLA Breached: ",h.slaBreached]})]}),t.jsx("button",{type:"button",className:"action-btn mt-3",onClick:I,children:"Export Ticket Workflow CSV"})]}),t.jsx("section",{className:"panel-card",children:L?t.jsxs("div",{className:"grid gap-2",children:[t.jsx("div",{className:"skeleton h-12"}),t.jsx("div",{className:"skeleton h-12"}),t.jsx("div",{className:"skeleton h-12"})]}):t.jsxs("div",{className:"space-y-3",children:[r.length?null:t.jsx("p",{className:"text-sm text-text-secondary",children:"No tickets found for current filters."}),r.map(e=>t.jsx("article",{className:`rounded-sm border p-3 ${e.slaBreached?"border-danger/40 bg-danger/5":"border-border bg-background"}`,children:t.jsxs("div",{className:"grid gap-2 lg:grid-cols-[1.2fr_auto_auto_auto_auto_auto]",children:[t.jsxs("div",{children:[t.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[t.jsx("h2",{className:"text-sm font-semibold text-text-primary",children:e.ticketId||"Ticket"}),t.jsx("span",{className:`rounded-full border px-2 py-1 text-[11px] font-semibold ${D[e.priority]||"border-border bg-background text-text-secondary"}`,children:e.priority||"p3"}),e.slaBreached?t.jsx("span",{className:"rounded-full border border-danger/30 bg-danger/10 px-2 py-1 text-[11px] font-semibold text-danger",children:"SLA breached"}):null]}),t.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:[e.studentName||"-"," | ",e.className||"-"," | ",e.subject||"-"]}),t.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["status: ",e.ticketStatus," | workflow: ",e.workflowStatus||"-"," | due: ",e.slaDueAt?new Date(e.slaDueAt).toLocaleString("en-US"):"-"]})]}),t.jsx("select",{value:e.ticketStatus||"open",onChange:s=>m(e.id,{ticketStatus:s.target.value},`Ticket status moved to ${s.target.value}.`),className:"focus-ring rounded-sm border border-border bg-white px-2 py-2 text-xs",disabled:p===e.id,children:A.map(s=>t.jsx("option",{value:s,children:s},`${e.id}-status-${s}`))}),t.jsx("select",{value:e.priority||"p3",onChange:s=>m(e.id,{priority:s.target.value},`Ticket priority set to ${s.target.value}.`),className:"focus-ring rounded-sm border border-border bg-white px-2 py-2 text-xs",disabled:p===e.id,children:E.map(s=>t.jsx("option",{value:s,children:s},`${e.id}-priority-${s}`))}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",disabled:p===e.id,onClick:()=>m(e.id,{firstResponse:!0},"First response timestamp recorded."),children:"First Response"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",disabled:p===e.id,onClick:()=>m(e.id,{escalate:!0},"Ticket escalated."),children:"Escalate"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>T(e.id),children:"Thread"})]})},e.id))]})}),c?t.jsxs("section",{className:"panel-card space-y-3",children:[t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Ticket Thread"}),t.jsx("button",{type:"button",className:"action-btn",onClick:()=>T(""),children:"Close"})]}),t.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 text-sm",children:[t.jsx("p",{className:"font-semibold text-text-primary",children:c.ticketId}),t.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Student: ",c.studentName||"-"," | Class: ",c.className||"-"," | Subject: ",c.subject||"-"]}),t.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Status: ",c.ticketStatus," | Priority: ",c.priority]})]}),t.jsxs("div",{className:"space-y-2",children:[((i==null?void 0:i.replies)||[]).map((e,s)=>t.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 text-xs",children:[t.jsx("p",{className:"font-semibold text-text-primary",children:e.senderType||"sender"}),t.jsx("p",{className:"mt-1 text-text-secondary",children:e.text||"-"}),t.jsx("p",{className:"mt-1 text-text-secondary",children:e.createdAt?new Date(e.createdAt).toLocaleString("en-US"):"-"})]},`${e.createdAt}-${s}`)),(C=i==null?void 0:i.replies)!=null&&C.length?null:t.jsx("p",{className:"text-sm text-text-secondary",children:"No threaded replies available for this ticket yet."})]})]}):null]})}export{V as default};
