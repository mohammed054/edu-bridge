import{u as ne,a as le,r,j as e}from"./index-df1SZI71.js";import{a5 as ce,S as ie,T as de,a6 as oe,V as xe,a7 as ue}from"./api-x0wxRGLh.js";import{M as I}from"./teacherPortal-BoVOU_PB.js";const J={1:"الإثنين",2:"الثلاثاء",3:"الأربعاء",4:"الخميس",5:"الجمعة"},pe={pendingResponses:0,flaggedParents:0,repeatedIncidents:0},he=(b=[])=>b.reduce((l,o)=>(l[o.name]=o.students||[],l),{});function ve(){var G,V;const b=ne(),{token:l}=le(),[o,T]=r.useState(!0),[c,i]=r.useState(!1),[M,n]=r.useState(""),[P,x]=r.useState(""),[u,Q]=r.useState(""),[f,U]=r.useState([]),[d,X]=r.useState({}),[v,Z]=r.useState(pe),[j,p]=r.useState({open:!1,entry:null}),[A,D]=r.useState(new Date().toISOString().slice(0,10)),[E,F]=r.useState({}),[L,h]=r.useState({open:!1,entry:null}),[g,O]=r.useState(""),[N,R]=r.useState(""),[y,m]=r.useState({open:!1,entry:null}),[S,B]=r.useState(""),[W,H]=r.useState("low"),[k,Y]=r.useState(""),_=async()=>{try{T(!0),n("");const[t,s,a]=await Promise.all([ce(l),ie(l),de(l)]);U(t.entries||[]),X(he(s.classes||[])),Z({pendingResponses:Number(a.pendingResponses||0),flaggedParents:Number(a.flaggedParents||0),repeatedIncidents:Number(a.repeatedIncidents||0)})}catch(t){n((t==null?void 0:t.message)||"تعذر تحميل جدول المعلم.")}finally{T(!1)}};r.useEffect(()=>{_()},[l]);const w=r.useMemo(()=>u?f.filter(t=>String(t.dayOfWeek)===String(u)):f,[u,f]),z=r.useMemo(()=>w.reduce((t,s)=>{const a=String(s.dayOfWeek);return t[a]||(t[a]=[]),t[a].push(s),t},{}),[w]),C=()=>{n(""),x("")},$=t=>{C();const a=(d[t.className]||[]).reduce((q,re)=>(q[re.id]="present",q),{});F(a),D(new Date().toISOString().slice(0,10)),p({open:!0,entry:t})},K=async()=>{const t=j.entry;if(!t)return;const s=d[t.className]||[];if(!s.length){n("لا يوجد طلاب ضمن الصف المحدد.");return}try{i(!0),n(""),await oe(l,{className:t.className,subject:t.subject,attendanceDate:A,slotStartTime:t.startTime,slotEndTime:t.endTime,entries:s.map(a=>({studentId:a.id,status:E[a.id]||"present"}))}),x("تم حفظ الحضور."),p({open:!1,entry:null})}catch(a){n((a==null?void 0:a.message)||"تعذر حفظ الحضور.")}finally{i(!1)}},ee=t=>{C(),O(""),R(""),h({open:!0,entry:t})},te=async()=>{const t=L.entry;if(t){if(!g.trim()||!N.trim()){n("عنوان ومحتوى التحديث مطلوبان.");return}try{i(!0),n(""),await xe(l,{className:t.className,subject:t.subject,title:g.trim(),body:N.trim()}),x("تم نشر التحديث."),h({open:!1,entry:null})}catch(s){n((s==null?void 0:s.message)||"تعذر نشر التحديث.")}finally{i(!1)}}},se=t=>{var a;C();const s=d[t.className]||[];B(((a=s[0])==null?void 0:a.id)||""),H("low"),Y(""),m({open:!0,entry:t})},ae=async()=>{const t=y.entry;if(t){if(!S||!k.trim()){n("الطالب ووصف الحادثة مطلوبان.");return}try{i(!0),n(""),await ue(l,{className:t.className,subject:t.subject,studentId:S,severity:W,description:k.trim()}),x("تم تسجيل الحادثة وإرسال إشعار ولي الأمر تلقائياً."),m({open:!1,entry:null}),await _()}catch(s){n((s==null?void 0:s.message)||"تعذر تسجيل الحادثة.")}finally{i(!1)}}};return e.jsxs("main",{dir:"rtl",className:"ht-theme min-h-screen bg-[var(--ht-bg-base)]",children:[e.jsxs("div",{className:"mx-auto max-w-[1200px] px-4 py-8 sm:px-6 lg:px-12",children:[e.jsxs("header",{className:"mb-8 flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"ht-display text-[30px] font-semibold text-[var(--ht-neutral-900)]",children:"الجدول الأسبوعي"}),e.jsx("p",{className:"mt-1 text-[13px] text-[var(--ht-neutral-500)]",children:"نظرة تشغيلية على حصصك الأكاديمية"})]}),e.jsx("button",{type:"button",onClick:()=>b("/teacher"),className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-4 text-[13px] font-medium text-[var(--ht-neutral-700)] hover:bg-[var(--ht-bg-subtle)]",children:"العودة للبوابة"})]}),M?e.jsx("p",{className:"mb-4 rounded-[4px] border border-[var(--ht-danger-100)] bg-[var(--ht-danger-100)] px-3 py-2 text-[13px] text-[var(--ht-danger-600)]",children:M}):null,P?e.jsx("p",{className:"mb-4 rounded-[4px] border border-[var(--ht-success-100)] bg-[var(--ht-success-100)] px-3 py-2 text-[13px] text-[var(--ht-success-600)]",children:P}):null,e.jsxs("section",{className:"mb-6 grid gap-3 sm:grid-cols-3",children:[e.jsxs("article",{className:"ht-surface p-4",children:[e.jsx("p",{className:"text-[12px] text-[var(--ht-neutral-500)]",children:"Pending responses"}),e.jsx("p",{className:"mt-2 text-[24px] font-semibold text-[var(--ht-neutral-900)]",children:v.pendingResponses})]}),e.jsxs("article",{className:"ht-surface p-4",children:[e.jsx("p",{className:"text-[12px] text-[var(--ht-neutral-500)]",children:"Flagged parents"}),e.jsx("p",{className:"mt-2 text-[24px] font-semibold text-[var(--ht-neutral-900)]",children:v.flaggedParents})]}),e.jsxs("article",{className:"ht-surface p-4",children:[e.jsx("p",{className:"text-[12px] text-[var(--ht-neutral-500)]",children:"Repeated incidents"}),e.jsx("p",{className:"mt-2 text-[24px] font-semibold text-[var(--ht-neutral-900)]",children:v.repeatedIncidents})]})]}),e.jsxs("section",{className:"mb-4 flex items-center justify-between gap-3",children:[e.jsx("h2",{className:"text-[20px] font-semibold text-[var(--ht-neutral-900)]",children:"الحصص"}),e.jsxs("select",{value:u,onChange:t=>Q(t.target.value),className:"h-10 rounded-[4px] border border-[var(--ht-border-default)] bg-white px-3 text-[13px] text-[var(--ht-neutral-700)]",children:[e.jsx("option",{value:"",children:"كل الأيام"}),Object.entries(J).map(([t,s])=>e.jsx("option",{value:t,children:s},t))]})]}),o?e.jsxs("section",{className:"grid gap-3",children:[e.jsx("div",{className:"skeleton h-20"}),e.jsx("div",{className:"skeleton h-20"}),e.jsx("div",{className:"skeleton h-20"})]}):w.length?e.jsx("section",{className:"space-y-5",children:Object.keys(z).sort((t,s)=>Number(t)-Number(s)).map(t=>e.jsxs("article",{className:"ht-surface p-5",children:[e.jsx("h3",{className:"mb-4 text-[18px] font-semibold text-[var(--ht-neutral-900)]",children:J[t]||t}),e.jsx("div",{className:"grid gap-3",children:z[t].slice().sort((s,a)=>String(s.startTime).localeCompare(String(a.startTime))).map(s=>e.jsx("div",{className:"rounded-[4px] border border-[var(--ht-border-subtle)] bg-[var(--ht-bg-subtle)] p-4",children:e.jsxs("div",{className:"mb-3 flex flex-wrap items-center justify-between gap-3",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-[14px] font-semibold text-[var(--ht-neutral-900)]",children:[s.startTime," - ",s.endTime]}),e.jsxs("p",{className:"text-[13px] text-[var(--ht-neutral-600)]",children:[s.className," · ",s.subject," · ",s.room||"-"]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",onClick:()=>$(s),className:"ht-interactive inline-flex h-9 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[12px] font-medium text-[var(--ht-neutral-700)] hover:bg-[var(--ht-bg-base)]",children:"Mark attendance"}),e.jsx("button",{type:"button",onClick:()=>ee(s),className:"ht-interactive inline-flex h-9 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[12px] font-medium text-[var(--ht-neutral-700)] hover:bg-[var(--ht-bg-base)]",children:"Post update"}),e.jsx("button",{type:"button",onClick:()=>se(s),className:"ht-interactive inline-flex h-9 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[12px] font-medium text-[var(--ht-neutral-700)] hover:bg-[var(--ht-bg-base)]",children:"Log incident"})]})]})},s.id))})]},t))}):e.jsx("section",{className:"ht-surface p-8 text-center",children:e.jsx("p",{className:"text-[16px] font-medium text-[var(--ht-neutral-800)]",children:"Schedule not yet assigned."})})]}),e.jsxs(I,{open:j.open,onClose:()=>p({open:!1,entry:null}),title:"تسجيل الحضور",description:"تحديد حالة حضور الطلاب للحصة.",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>p({open:!1,entry:null}),className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-4 text-[13px] text-[var(--ht-neutral-700)]",children:"إلغاء"}),e.jsx("button",{type:"button",disabled:c,onClick:K,className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-primary-600)] bg-[var(--ht-primary-600)] px-4 text-[13px] text-white disabled:opacity-60",children:c?"جارٍ الحفظ...":"حفظ"})]}),children:[e.jsxs("label",{className:"mb-3 block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"تاريخ الحصة"}),e.jsx("input",{type:"date",value:A,onChange:t=>D(t.target.value),className:"h-10 w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[13px]"})]}),e.jsx("div",{className:"space-y-2",children:(d[(G=j.entry)==null?void 0:G.className]||[]).map(t=>e.jsxs("div",{className:"flex items-center justify-between rounded-[4px] border border-[var(--ht-border-subtle)] p-2",children:[e.jsx("p",{className:"text-[13px] text-[var(--ht-neutral-700)]",children:t.name}),e.jsxs("select",{value:E[t.id]||"present",onChange:s=>F(a=>({...a,[t.id]:s.target.value})),className:"h-8 rounded-[4px] border border-[var(--ht-border-default)] px-2 text-[12px]",children:[e.jsx("option",{value:"present",children:"Present"}),e.jsx("option",{value:"absent",children:"Absent"}),e.jsx("option",{value:"late",children:"Late"})]})]},t.id))})]}),e.jsxs(I,{open:L.open,onClose:()=>h({open:!1,entry:null}),title:"نشر تحديث أكاديمي",description:"سيظهر التحديث ضمن مادة الحصة فقط.",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>h({open:!1,entry:null}),className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-4 text-[13px] text-[var(--ht-neutral-700)]",children:"إلغاء"}),e.jsx("button",{type:"button",disabled:c,onClick:te,className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-primary-600)] bg-[var(--ht-primary-600)] px-4 text-[13px] text-white disabled:opacity-60",children:c?"جارٍ الحفظ...":"نشر"})]}),children:[e.jsxs("label",{className:"mb-3 block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"العنوان"}),e.jsx("input",{type:"text",value:g,onChange:t=>O(t.target.value),className:"h-10 w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[13px]"})]}),e.jsxs("label",{className:"block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"المحتوى"}),e.jsx("textarea",{value:N,onChange:t=>R(t.target.value),className:"min-h-[110px] w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 py-2 text-[13px]"})]})]}),e.jsx(I,{open:y.open,onClose:()=>m({open:!1,entry:null}),title:"تسجيل حادثة سلوكية",description:"سيتم إرسال إشعار ولي الأمر تلقائياً.",footer:e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>m({open:!1,entry:null}),className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-border-default)] px-4 text-[13px] text-[var(--ht-neutral-700)]",children:"إلغاء"}),e.jsx("button",{type:"button",disabled:c,onClick:ae,className:"ht-interactive inline-flex h-10 items-center justify-center rounded-[4px] border border-[var(--ht-primary-600)] bg-[var(--ht-primary-600)] px-4 text-[13px] text-white disabled:opacity-60",children:c?"جارٍ الحفظ...":"تسجيل"})]}),children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("label",{className:"block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"الطالب"}),e.jsx("select",{value:S,onChange:t=>B(t.target.value),className:"h-10 w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[13px]",children:(d[(V=y.entry)==null?void 0:V.className]||[]).map(t=>e.jsx("option",{value:t.id,children:t.name},t.id))})]}),e.jsxs("label",{className:"block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"الشدة"}),e.jsxs("select",{value:W,onChange:t=>H(t.target.value),className:"h-10 w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 text-[13px]",children:[e.jsx("option",{value:"low",children:"Low"}),e.jsx("option",{value:"medium",children:"Medium"}),e.jsx("option",{value:"high",children:"High"})]})]}),e.jsxs("label",{className:"block",children:[e.jsx("span",{className:"mb-2 block text-[13px] text-[var(--ht-neutral-600)]",children:"وصف الحادثة"}),e.jsx("textarea",{value:k,onChange:t=>Y(t.target.value),className:"min-h-[110px] w-full rounded-[4px] border border-[var(--ht-border-default)] px-3 py-2 text-[13px]"})]})]})})]})}export{ve as default};
