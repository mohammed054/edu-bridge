import{a as P,r as c,j as e}from"./index-df1SZI71.js";import{L as U}from"./api-x0wxRGLh.js";import{P as D}from"./PageHeading-CUjM0fdU.js";const $={students:[],teachers:[]},F=t=>JSON.stringify(t,null,2),I=t=>{const r=t&&typeof t=="object"?t:{};return{students:Array.isArray(r.students)?r.students:[],teachers:Array.isArray(r.teachers)?r.teachers:[]}},T=t=>{try{return{parsed:JSON.parse(t),error:""}}catch{return{parsed:null,error:"ملف JSON غير صالح."}}},z=t=>{const r=[],p=new Set;let l=0;return t.students.forEach((a,n)=>{const o=String((a==null?void 0:a.email)||"").trim().toLowerCase(),d=String((a==null?void 0:a.className)||"").trim();String((a==null?void 0:a.fullName)||"").trim()||(l+=1,r.push(`طالب رقم ${n+1}: الاسم الكامل مطلوب.`)),o?p.has(o)?(l+=1,r.push(`طالب رقم ${n+1}: البريد الإلكتروني مكرر داخل الملف.`)):p.add(o):(l+=1,r.push(`طالب رقم ${n+1}: البريد الإلكتروني مطلوب.`)),d||(l+=1,r.push(`طالب رقم ${n+1}: يجب تحديد صف واحد عبر className.`))}),t.teachers.forEach((a,n)=>{const o=String((a==null?void 0:a.email)||"").trim().toLowerCase(),d=String((a==null?void 0:a.subject)||"").trim(),N=Array.isArray(a==null?void 0:a.classes)?a.classes.filter(Boolean):[];String((a==null?void 0:a.fullName)||"").trim()||(l+=1,r.push(`معلم رقم ${n+1}: الاسم الكامل مطلوب.`)),o?p.has(o)?(l+=1,r.push(`معلم رقم ${n+1}: البريد الإلكتروني مكرر داخل الملف.`)):p.add(o):(l+=1,r.push(`معلم رقم ${n+1}: البريد الإلكتروني مطلوب.`)),d||(l+=1,r.push(`معلم رقم ${n+1}: المادة مطلوبة ويجب أن تكون مادة واحدة.`)),N.length||(l+=1,r.push(`معلم رقم ${n+1}: يجب تحديد صف واحد على الأقل داخل classes[].`))}),{errors:r,skipped:l,validCount:t.students.length+t.teachers.length-l}};function H(){const{token:t}=P(),[r,p]=c.useState($),[l,a]=c.useState(F($)),[n,o]=c.useState(""),[d,N]=c.useState(!0),[u,j]=c.useState(!1),[b,g]=c.useState(""),[k,y]=c.useState(""),[i,v]=c.useState(null),[m,S]=c.useState(null),[E,w]=c.useState(!1),x=c.useMemo(()=>z(r),[r]),C=s=>{a(s),y(""),S(null);const{parsed:h,error:f}=T(s);if(f){g(f);return}g(""),p(I(h))},J=async s=>{var L;const h=(L=s.target.files)==null?void 0:L[0];if(!h)return;const f=await h.text();o(h.name),C(f)},A=async()=>{if(!b)try{j(!0),y(""),S(null);const s=await U(t,r,{dryRun:!0,autoCreateClasses:d});v(s),y("تم التحقق من الملف بنجاح. راجع النتائج ثم أكد الاستيراد.")}catch(s){g(s.message||"تعذر التحقق من الملف.")}finally{j(!1)}},R=async()=>{try{j(!0),g("");const s=await U(t,r,{autoCreateClasses:d});S(s),w(!1),y("تم استيراد المستخدمين بنجاح.")}catch(s){g(s.message||"تعذر استيراد المستخدمين.")}finally{j(!1)}},O=!b&&(i||x.errors.length===0);return e.jsxs("div",{className:"page-enter space-y-5 p-1",children:[e.jsx(D,{title:"استيراد المستخدمين",subtitle:"رفع ملف JSON، معاينة البيانات، التحقق المسبق، ثم تأكيد الاستيراد."}),b?e.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:b}):null,k?e.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:k}):null,e.jsxs("section",{className:"panel-card space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("label",{className:"action-btn cursor-pointer",children:["رفع ملف JSON",e.jsx("input",{type:"file",accept:"application/json,.json",className:"hidden",onChange:J})]}),e.jsxs("label",{className:"inline-flex items-center gap-2 text-sm text-text-secondary",children:[e.jsx("input",{type:"checkbox",checked:d,onChange:s=>N(s.target.checked)}),"إنشاء الصفوف غير الموجودة تلقائياً"]}),n?e.jsxs("span",{className:"caption-premium",children:["الملف: ",n]}):null]}),e.jsxs("label",{className:"space-y-2",children:[e.jsx("span",{className:"caption-premium font-semibold text-text-primary",children:"بيانات JSON"}),e.jsx("textarea",{value:l,onChange:s=>C(s.target.value),className:"focus-ring min-h-[220px] w-full rounded-sm border border-border bg-white px-3 py-2 text-sm",dir:"ltr",spellCheck:!1})]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:A,disabled:u||!!b,children:"تحقق قبل الاستيراد"}),e.jsx("button",{type:"button",className:"action-btn-primary",onClick:()=>w(!0),disabled:u||!O,children:"تأكيد الاستيراد"})]})]}),e.jsxs("section",{className:"panel-card space-y-3",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"معاينة البيانات"}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"عدد الطلاب"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(r.students.length).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"عدد المعلمين"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(r.teachers.length).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"صالح مبدئياً"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(Math.max(0,x.validCount)).toLocaleString("en-US")})]})]}),x.errors.length?e.jsxs("div",{className:"rounded-sm border border-warning/25 bg-warning/10 p-3",children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-warning",children:"ملاحظات التحقق المحلي"}),e.jsx("ul",{className:"space-y-1 text-sm text-text-secondary",children:x.errors.slice(0,12).map(s=>e.jsxs("li",{children:["- ",s]},s))}),x.errors.length>12?e.jsxs("p",{className:"mt-2 text-xs text-text-secondary",children:["+",Number(x.errors.length-12).toLocaleString("en-US")," ملاحظة إضافية"]}):null]}):null]}),i?e.jsxs("section",{className:"panel-card space-y-2",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"نتيجة التحقق من الخادم"}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-4",children:[e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"طلاب جاهزون"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(i.importedStudents||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"معلمون جاهزون"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(i.importedTeachers||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"تم تخطيهم"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(i.skipped||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"أخطاء"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number((i.errors||[]).length).toLocaleString("en-US")})]})]}),(i.errors||[]).length?e.jsxs("div",{className:"rounded-sm border border-warning/25 bg-warning/10 p-3",children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-warning",children:"أسباب السجلات المتخطاة"}),e.jsx("ul",{className:"space-y-1 text-sm text-text-secondary",children:(i.errors||[]).slice(0,12).map(s=>e.jsxs("li",{children:["- [",s.role,"] #",s.index," ",s.email||"",": ",s.message]},`${s.role}-${s.index}-${s.email}-${s.code}`))})]}):null]}):null,m?e.jsxs("section",{className:"panel-card space-y-2",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"ملخص الاستيراد النهائي"}),e.jsxs("div",{className:"grid gap-3 md:grid-cols-4",children:[e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"طلاب مستوردون"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(m.importedStudents||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"معلمون مستوردون"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(m.importedTeachers||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"تم تخطيهم"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(m.skipped||0).toLocaleString("en-US")})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background px-3 py-2",children:[e.jsx("p",{className:"caption-premium",children:"مكررون"}),e.jsx("p",{className:"text-lg font-semibold text-text-primary",children:Number(m.skippedDuplicates||0).toLocaleString("en-US")})]})]}),(m.errors||[]).length?e.jsxs("div",{className:"rounded-sm border border-warning/25 bg-warning/10 p-3",children:[e.jsx("p",{className:"mb-2 text-sm font-semibold text-warning",children:"تفاصيل السجلات المتخطاة"}),e.jsx("ul",{className:"space-y-1 text-sm text-text-secondary",children:(m.errors||[]).slice(0,12).map(s=>e.jsxs("li",{children:["- [",s.role,"] #",s.index," ",s.email||"",": ",s.message]},`${s.role}-${s.index}-${s.email}-${s.code}`))})]}):null]}):null,E?e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/35 p-4",children:e.jsxs("div",{className:"animate-fadeUp w-full max-w-lg rounded-md border border-border bg-surface p-5 shadow-lg",children:[e.jsx("h3",{className:"text-lg font-semibold text-text-primary",children:"تأكيد استيراد المستخدمين"}),e.jsx("p",{className:"mt-2 text-sm text-text-secondary",children:"سيتم إنشاء الحسابات الصالحة فقط، وتخطي السجلات غير المطابقة للقواعد."}),e.jsxs("div",{className:"mt-3 grid gap-2 sm:grid-cols-2",children:[e.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm",children:["الطلاب: ",Number(r.students.length).toLocaleString("en-US")]}),e.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm",children:["المعلمون: ",Number(r.teachers.length).toLocaleString("en-US")]})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{type:"button",className:"action-btn",onClick:()=>w(!1),children:"إلغاء"}),e.jsx("button",{type:"button",className:"action-btn-primary",onClick:R,disabled:u,children:u?"جارٍ الاستيراد...":"تأكيد"})]})]})}):null]})}export{H as default};
