import{a as Be,r as a,j as s}from"./index-df1SZI71.js";import{b as Fe,c as Ue,d as Ge,e as He,g as ze,h as Ke,i as We}from"./api-x0wxRGLh.js";import{P as qe}from"./PageHeading-CUjM0fdU.js";import{u as Ye}from"./AdminEnterpriseContext-BE79oEoc.js";const U=["active","probation","academic_warning","suspended","graduated","transferred","archived"],Je=[{value:"name",label:"Name"},{value:"email",label:"Email"},{value:"absentDays",label:"Absent Days"},{value:"negativeReports",label:"Negative Reports"},{value:"studentLifecycleState",label:"Lifecycle State"}],G=[{key:"name",label:"Name"},{key:"email",label:"Email"},{key:"className",label:"Class"},{key:"grade",label:"Grade"},{key:"riskLevel",label:"Risk"},{key:"attendanceMisses",label:"Attendance Misses"},{key:"averageGrade",label:"Average Grade"},{key:"lifecycleState",label:"Lifecycle"},{key:"isActive",label:"Status"}],fe=G.map(r=>r.key),je=(r,m)=>{const i=new Blob([r],{type:"text/csv;charset=utf-8"}),n=window.URL.createObjectURL(i),d=document.createElement("a");d.href=n,d.download=m,document.body.appendChild(d),d.click(),document.body.removeChild(d),window.URL.revokeObjectURL(n)},Qe=(r,m)=>{const i=n=>{const d=String(n??"");return/[",\n]/.test(d)?`"${d.replace(/"/g,'""')}"`:d};return[r.join(","),...m.map(n=>n.map(d=>i(d)).join(","))].join(`
`)},Xe=r=>r?"Active":"Disabled";function as(){var xe,me,pe,be,he,ge,ye,ve;const{token:r}=Be(),{selectedGrade:m,selectedClass:i}=Ye(),[n,d]=a.useState([]),[g,u]=a.useState(1),[V,Ne]=a.useState(25),[Se,ke]=a.useState(0),[O,we]=a.useState(1),[$,H]=a.useState(!0),[y,x]=a.useState(!1),[z,c]=a.useState(""),[K,N]=a.useState(""),[S,W]=a.useState(""),[b,P]=a.useState(""),[v,R]=a.useState(""),[k,q]=a.useState(""),[w,Y]=a.useState(""),[C,J]=a.useState("name"),[L,Q]=a.useState("asc"),[f,Ce]=a.useState({classNames:[],grades:[],riskLevels:["low","medium","high"],lifecycleStates:U}),[p,A]=a.useState(new Set),[h,Le]=a.useState("activate"),[_,Ae]=a.useState(""),[X,Ee]=a.useState("active"),[Z,ee]=a.useState([]),[E,M]=a.useState(""),[I,se]=a.useState(""),[te,ae]=a.useState(!1),[D,le]=a.useState(fe),[De,re]=a.useState(!1),[o,T]=a.useState(null),[Ve,ce]=a.useState(""),ne=a.useMemo(()=>({page:g,pageSize:V,search:S,className:b,grade:v,riskLevel:k,lifecycleState:w,sortBy:C,sortOrder:L}),[g,V,S,b,v,k,w,C,L]),de=e=>{const t=(e==null?void 0:e.filters)||{},l=(e==null?void 0:e.sort)||{};W(String(t.search||"")),P(String(t.className||"")),R(String(t.grade||"")),q(String(t.riskLevel||"")),Y(String(t.lifecycleState||"")),J(String(l.sortBy||"name")),Q(String(l.sortOrder||"asc")),le(Array.isArray(e==null?void 0:e.columns)&&e.columns.length?e.columns:fe),u(1)},B=async()=>{try{const t=(await Fe(r,{moduleKey:"students"})).views||[];ee(t);const l=t.find(j=>j.isDefault);l&&!E&&(M(l.id),de(l))}catch{ee([])}},oe=async()=>{try{H(!0),c("");const e=await Ue(r,ne);d(e.rows||[]),ke(Number(e.totalCount||0)),we(Math.max(1,Number(e.totalPages||1))),Ce(e.availableFilters||{classNames:[],grades:[],riskLevels:["low","medium","high"],lifecycleStates:U})}catch(e){c(e.message||"Failed to load students."),d([])}finally{H(!1)}};a.useEffect(()=>{B()},[r]),a.useEffect(()=>{m&&!v&&R(m),i!=null&&i.name&&!b&&P(i.name)},[m,i==null?void 0:i.name]),a.useEffect(()=>{oe(),A(new Set)},[r,ne]);const ie=a.useMemo(()=>n.filter(e=>p.has(e.id)),[n,p]),ue=n.length>0&&n.every(e=>p.has(e.id)),F=a.useMemo(()=>G.filter(e=>D.includes(e.key)),[D]),Oe=e=>{A(t=>{const l=new Set(t);return l.has(e)?l.delete(e):l.add(e),l})},$e=()=>{A(e=>{const t=new Set(e);return ue?n.forEach(l=>t.delete(l.id)):n.forEach(l=>t.add(l.id)),t})},Pe=async()=>{if(!p.size){c("Select at least one student row first.");return}const e={studentIds:[...p],action:h,payload:{}};if(h==="move_class"){if(!_){c("Choose target class for bulk move.");return}e.payload.className=_}h==="set_lifecycle"&&(e.payload.lifecycleState=X);try{x(!0),c(""),N("");const t=await Ge(r,e);N(`Bulk action completed. Updated ${Number(t.modifiedCount||0)} rows.`),await oe(),A(new Set)}catch(t){c(t.message||"Bulk action failed.")}finally{x(!1)}},Re=async()=>{try{x(!0),c("");const e=await He(r,{className:b});je(e,`students-filtered-${new Date().toISOString().slice(0,10)}.csv`)}catch(e){c(e.message||"Failed to export student list.")}finally{x(!1)}},_e=()=>{if(!ie.length){c("Select at least one row before exporting selected.");return}const e=Qe(["name","email","className","grade","riskLevel","attendanceMisses","lifecycleState","averageGrade","isActive"],ie.map(t=>[t.name,t.email,t.className,t.grade,t.riskLevel,t.attendanceMisses,t.lifecycleState,t.averageGrade,t.isActive?"true":"false"]));je(e,`students-selected-${new Date().toISOString().slice(0,10)}.csv`)},Me=async()=>{if(!I.trim()){c("Enter a view title before saving.");return}try{x(!0),c(""),await ze(r,{moduleKey:"students",title:I.trim(),filters:{search:S,className:b,grade:v,riskLevel:k,lifecycleState:w},sort:{sortBy:C,sortOrder:L},columns:D,isDefault:te}),se(""),ae(!1),await B(),N("Saved view created.")}catch(e){c(e.message||"Failed to save view.")}finally{x(!1)}},Ie=async()=>{if(!E){c("Select a saved view first.");return}try{x(!0),c(""),await Ke(r,E),M(""),await B(),N("Saved view deleted.")}catch(e){c(e.message||"Failed to delete view.")}finally{x(!1)}},Te=async e=>{try{re(!0),ce(e);const t=await We(r,e);T(t)}catch(t){c(t.message||"Failed to load student detail."),T(null)}finally{re(!1)}};return s.jsxs("div",{className:"page-enter space-y-5 p-1",children:[s.jsx(qe,{title:"Enterprise Student Management",subtitle:"Server-driven tables, saved views, bulk operations, and full entity detail."}),z?s.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:z}):null,K?s.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:K}):null,s.jsxs("section",{className:"panel-card space-y-4",children:[s.jsxs("div",{className:"grid gap-3 md:grid-cols-3 xl:grid-cols-4",children:[s.jsx("input",{value:S,onChange:e=>{W(e.target.value),u(1)},className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Search name or email"}),s.jsxs("select",{value:b,onChange:e=>{P(e.target.value),u(1)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"All classes"}),(f.classNames||[]).map(e=>s.jsx("option",{value:e,children:e},e))]}),s.jsxs("select",{value:v,onChange:e=>{R(e.target.value),u(1)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"All grades"}),(f.grades||[]).map(e=>s.jsx("option",{value:e,children:e},e))]}),s.jsxs("select",{value:k,onChange:e=>{q(e.target.value),u(1)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"All risk levels"}),(f.riskLevels||[]).map(e=>s.jsx("option",{value:e,children:e},e))]}),s.jsxs("select",{value:w,onChange:e=>{Y(e.target.value),u(1)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"All lifecycle states"}),(f.lifecycleStates||[]).map(e=>s.jsx("option",{value:e,children:e},e))]}),s.jsx("select",{value:C,onChange:e=>J(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:Je.map(e=>s.jsxs("option",{value:e.value,children:["Sort by ",e.label]},e.value))}),s.jsxs("select",{value:L,onChange:e=>Q(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"asc",children:"Ascending"}),s.jsx("option",{value:"desc",children:"Descending"})]}),s.jsx("select",{value:String(V),onChange:e=>{Ne(Number(e.target.value)),u(1)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[25,50,100,200].map(e=>s.jsxs("option",{value:e,children:[e," per page"]},e))})]}),s.jsxs("div",{className:"grid gap-3 lg:grid-cols-[1fr_auto]",children:[s.jsxs("div",{className:"grid gap-2 md:grid-cols-[1fr_220px_auto_auto]",children:[s.jsx("input",{value:I,onChange:e=>se(e.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"New saved view title"}),s.jsxs("select",{value:E,onChange:e=>{const t=e.target.value;M(t);const l=Z.find(j=>j.id===t);l&&de(l)},className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"Saved views"}),Z.map(e=>s.jsxs("option",{value:e.id,children:[e.title,e.isDefault?" (default)":""]},e.id))]}),s.jsx("button",{type:"button",className:"action-btn",onClick:Me,disabled:y,children:"Save View"}),s.jsx("button",{type:"button",className:"action-btn",onClick:Ie,disabled:y,children:"Delete View"})]}),s.jsxs("label",{className:"inline-flex items-center gap-2 text-xs text-text-secondary",children:[s.jsx("input",{type:"checkbox",checked:te,onChange:e=>ae(e.target.checked)}),"Mark default"]})]}),s.jsx("div",{className:"flex flex-wrap gap-2",children:G.map(e=>{const t=D.includes(e.key);return s.jsx("button",{type:"button",className:`action-btn rounded-full px-3 py-1 text-xs ${t?"border-transparent bg-primary text-white":""}`,onClick:()=>le(l=>l.includes(e.key)?l.length===1?l:l.filter(j=>j!==e.key):[...l,e.key]),children:e.label},e.key)})})]}),s.jsxs("section",{className:"panel-card space-y-4",children:[s.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[s.jsxs("p",{className:"text-sm font-semibold text-text-primary",children:[Se.toLocaleString("en-US")," students total"]}),s.jsxs("div",{className:"flex flex-wrap gap-2",children:[s.jsx("button",{type:"button",className:"action-btn",onClick:Re,disabled:y,children:"Export Filtered"}),s.jsx("button",{type:"button",className:"action-btn",onClick:_e,disabled:y,children:"Export Selected"})]})]}),s.jsxs("div",{className:"grid gap-2 md:grid-cols-[220px_220px_220px_auto]",children:[s.jsxs("select",{value:h,onChange:e=>Le(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"activate",children:"Activate"}),s.jsx("option",{value:"deactivate",children:"Deactivate"}),s.jsx("option",{value:"archive",children:"Archive"}),s.jsx("option",{value:"restore",children:"Restore"}),s.jsx("option",{value:"set_lifecycle",children:"Set lifecycle state"}),s.jsx("option",{value:"move_class",children:"Move class"})]}),h==="move_class"?s.jsxs("select",{value:_,onChange:e=>Ae(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[s.jsx("option",{value:"",children:"Select target class"}),(f.classNames||[]).map(e=>s.jsx("option",{value:e,children:e},`bulk-${e}`))]}):null,h==="set_lifecycle"?s.jsx("select",{value:X,onChange:e=>Ee(e.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:U.map(e=>s.jsx("option",{value:e,children:e},`lifecycle-${e}`))}):null,s.jsxs("button",{type:"button",className:"action-btn-primary",onClick:Pe,disabled:y,children:["Run Bulk Action (",p.size,")"]})]}),$?s.jsxs("div",{className:"grid gap-2",children:[s.jsx("div",{className:"skeleton h-12"}),s.jsx("div",{className:"skeleton h-12"}),s.jsx("div",{className:"skeleton h-12"})]}):s.jsx("div",{className:"overflow-auto",children:s.jsxs("table",{className:"min-w-full border-collapse text-left text-sm",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b border-border bg-background",children:[s.jsx("th",{className:"px-3 py-2",children:s.jsx("input",{type:"checkbox",checked:ue,onChange:$e})}),F.map(e=>s.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:e.label},`header-${e.key}`)),s.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Detail"})]})}),s.jsx("tbody",{children:n.length?n.map(e=>s.jsxs("tr",{className:"border-b border-border/60",children:[s.jsx("td",{className:"px-3 py-2",children:s.jsx("input",{type:"checkbox",checked:p.has(e.id),onChange:()=>Oe(e.id)})}),F.map(t=>s.jsx("td",{className:"px-3 py-2 text-text-primary",children:t.key==="isActive"?Xe(e.isActive):e[t.key]??"-"},`${e.id}-${t.key}`)),s.jsx("td",{className:"px-3 py-2",children:s.jsx("button",{type:"button",className:"action-btn",onClick:()=>Te(e.id),children:"Open"})})]},e.id)):s.jsx("tr",{children:s.jsx("td",{colSpan:F.length+2,className:"px-3 py-8 text-center text-text-secondary",children:"No students matched this view."})})})]})}),s.jsxs("div",{className:"flex items-center justify-between gap-3",children:[s.jsxs("p",{className:"text-xs text-text-secondary",children:["Page ",g," of ",O]}),s.jsxs("div",{className:"flex gap-2",children:[s.jsx("button",{type:"button",className:"action-btn",onClick:()=>u(e=>Math.max(1,e-1)),disabled:g<=1||$,children:"Previous"}),s.jsx("button",{type:"button",className:"action-btn",onClick:()=>u(e=>Math.min(O,e+1)),disabled:g>=O||$,children:"Next"})]})]})]}),Ve?s.jsxs("section",{className:"panel-card space-y-4",children:[s.jsxs("div",{className:"flex items-center justify-between",children:[s.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Student Entity View"}),s.jsx("button",{type:"button",className:"action-btn",onClick:()=>{ce(""),T(null)},children:"Close"})]}),De?s.jsxs("div",{className:"grid gap-2",children:[s.jsx("div",{className:"skeleton h-16"}),s.jsx("div",{className:"skeleton h-16"})]}):o?s.jsxs("div",{className:"grid gap-4 lg:grid-cols-2",children:[s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Overview"}),s.jsxs("p",{className:"mt-2 text-xs text-text-secondary",children:[(xe=o.student)==null?void 0:xe.name," | ",(me=o.student)==null?void 0:me.email," | Class ",((pe=o.student)==null?void 0:pe.className)||"-"]}),s.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Lifecycle: ",(be=o.student)==null?void 0:be.lifecycleState," | Avg grade: ",Number(((he=o.overview)==null?void 0:he.averageGrade)||0).toFixed(2)," | Absent: ",Number(((ge=o.overview)==null?void 0:ge.absentDays)||0)]})]}),s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Attendance Heatmap"}),s.jsx("div",{className:"mt-2 grid grid-cols-8 gap-2",children:(o.attendanceHeatmap||[]).slice(0,40).map(e=>{const t=String(e.status||"").toLowerCase(),l=t==="present"?"bg-success/80":t==="absent"?"bg-danger/80":t==="late"?"bg-warning/80":"bg-border";return s.jsx("div",{className:`h-5 rounded-sm ${l}`,title:`${e.date}: ${e.status}`},`${e.date}-${e.status}`)})})]}),s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 lg:col-span-2",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Schedule Preview"}),s.jsx("div",{className:"mt-2 overflow-auto",children:s.jsxs("table",{className:"min-w-full border-collapse text-left text-xs",children:[s.jsx("thead",{children:s.jsxs("tr",{className:"border-b border-border",children:[s.jsx("th",{className:"px-2 py-1",children:"Day"}),s.jsx("th",{className:"px-2 py-1",children:"Time"}),s.jsx("th",{className:"px-2 py-1",children:"Subject"}),s.jsx("th",{className:"px-2 py-1",children:"Teacher"}),s.jsx("th",{className:"px-2 py-1",children:"Room"})]})}),s.jsx("tbody",{children:(o.schedulePreview||[]).map(e=>s.jsxs("tr",{className:"border-b border-border/60",children:[s.jsx("td",{className:"px-2 py-1",children:e.dayOfWeek}),s.jsxs("td",{className:"px-2 py-1",children:[e.startTime," - ",e.endTime]}),s.jsx("td",{className:"px-2 py-1",children:e.subject}),s.jsx("td",{className:"px-2 py-1",children:e.teacherName}),s.jsx("td",{className:"px-2 py-1",children:e.room||"-"})]},`${e.dayOfWeek}-${e.startTime}-${e.subject}`))})]})})]}),s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Incident History"}),s.jsx("div",{className:"mt-2 space-y-2",children:(o.incidentHistory||[]).slice(0,8).map(e=>s.jsxs("div",{className:"rounded-sm border border-border p-2 text-xs",children:[s.jsx("p",{className:"font-semibold text-text-primary",children:e.subject||"Incident"}),s.jsx("p",{className:"text-text-secondary",children:e.description||"-"})]},e._id||`${e.createdAt}-${e.subject}`))})]}),s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Communication Log"}),s.jsx("div",{className:"mt-2 space-y-2",children:(o.communicationLog||[]).slice(0,8).map(e=>s.jsxs("div",{className:"rounded-sm border border-border p-2 text-xs",children:[s.jsx("p",{className:"font-semibold text-text-primary",children:e.subject||"Message"}),s.jsx("p",{className:"text-text-secondary",children:e.message||"-"}),s.jsxs("p",{className:"text-text-secondary",children:[e.senderRole," | ",e.ticketStatus]})]},e.id))})]}),s.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 lg:col-span-2",children:[s.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Lifecycle Panels"}),s.jsxs("p",{className:"mt-2 text-xs text-text-secondary",children:["Parent contact: ",((ye=o.parentContactBlock)==null?void 0:ye.message)||"Unavailable"]}),s.jsxs("p",{className:"mt-1 text-xs text-text-secondary",children:["Survey responses: ",Number(((ve=o.surveyParticipation)==null?void 0:ve.totalResponses)||0)]})]})]}):s.jsx("p",{className:"text-sm text-text-secondary",children:"No student detail loaded."})]}):null]})}export{as as default};
