import{a as F,r,j as e}from"./index-df1SZI71.js";import{f as O,l as U,e as D,B as _}from"./api-x0wxRGLh.js";import{P as A}from"./PageHeading-CUjM0fdU.js";const j=(n,x,p="text/plain;charset=utf-8")=>{const h=new Blob([n],{type:p}),c=window.URL.createObjectURL(h),l=document.createElement("a");l.href=c,l.download=x,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(c)};function W(){var v,S;const{token:n}=F(),[x,p]=r.useState(!0),[h,c]=r.useState(!1),[l,m]=r.useState(""),[g,b]=r.useState(""),[t,f]=r.useState(null),[o,y]=r.useState([]),[u,k]=r.useState(""),[i,w]=r.useState(""),[d,C]=r.useState("students_filtered"),R=async()=>{try{p(!0),m("");const[s,N]=await Promise.all([O(n,{grade:u,className:i}),U(n)]);f(s),y(N.rows||[])}catch(s){m(s.message||"Failed to load analytics reports."),f(null),y([])}finally{p(!1)}};r.useEffect(()=>{R()},[n,u,i]);const E=r.useMemo(()=>[...new Set(o.map(s=>String(s.grade||"").trim()).filter(Boolean))].sort(),[o]),T=r.useMemo(()=>o.map(s=>s.name).filter(Boolean).sort(),[o]),a=r.useMemo(()=>{var s;return t?{riskCount:(t.highRiskStudents||[]).length,conflictCount:(t.scheduleConflicts||[]).length,pendingTickets:Number(t.pendingFeedbackTickets||0),surveyParticipationRate:Number(t.surveyParticipationRate||0),surveyResponseCount:Number(t.surveyResponseCount||0),queueUnread:Number(((s=t.notificationQueue)==null?void 0:s.unread)||0)}:null},[t]),P=async()=>{try{if(c(!0),m(""),b(""),d==="students_filtered"){const s=await D(n,{className:i});j(s,`students-report-${new Date().toISOString().slice(0,10)}.csv`,"text/csv;charset=utf-8")}else if(d==="tickets_workflow"){const s=await _(n);j(s,`tickets-report-${new Date().toISOString().slice(0,10)}.csv`,"text/csv;charset=utf-8")}else d==="dashboard_snapshot"?j(JSON.stringify({generatedAt:new Date().toISOString(),filters:{gradeFilter:u,classFilter:i},dashboard:t,classes:o},null,2),`dashboard-snapshot-${new Date().toISOString().slice(0,10)}.json`,"application/json;charset=utf-8"):d==="print_pdf"&&window.print();b("Report export completed.")}catch(s){m(s.message||"Failed to export report.")}finally{c(!1)}};return e.jsxs("div",{className:"page-enter space-y-5 p-1",children:[e.jsx(A,{title:"Analytics and Reporting Engine",subtitle:"Operational dashboard with drill-down signals, comparative indicators, risk scoring surfaces, and custom exports."}),l?e.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:l}):null,g?e.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:g}):null,e.jsx("section",{className:"panel-card",children:e.jsxs("div",{className:"grid gap-3 md:grid-cols-4",children:[e.jsxs("select",{value:u,onChange:s=>k(s.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All grades"}),E.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("select",{value:i,onChange:s=>w(s.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All classes"}),T.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("select",{value:d,onChange:s=>C(s.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[e.jsx("option",{value:"students_filtered",children:"Export Students CSV"}),e.jsx("option",{value:"tickets_workflow",children:"Export Tickets CSV"}),e.jsx("option",{value:"dashboard_snapshot",children:"Export Dashboard Snapshot JSON"}),e.jsx("option",{value:"print_pdf",children:"Print to PDF"})]}),e.jsx("button",{type:"button",className:"action-btn-primary",onClick:P,disabled:h||x,children:"Run Report Export"})]})}),x?e.jsx("section",{className:"panel-card",children:e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-16"}),e.jsx("div",{className:"skeleton h-16"}),e.jsx("div",{className:"skeleton h-16"})]})}):e.jsxs(e.Fragment,{children:[e.jsxs("section",{className:"grid gap-3 md:grid-cols-3 xl:grid-cols-6",children:[e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"High-Risk Students"}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:Number((a==null?void 0:a.riskCount)||0)})]}),e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"Schedule Conflicts"}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:Number((a==null?void 0:a.conflictCount)||0)})]}),e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"Pending Tickets"}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:Number((a==null?void 0:a.pendingTickets)||0)})]}),e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"Survey Participation"}),e.jsxs("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:[Number((a==null?void 0:a.surveyParticipationRate)||0).toFixed(2),"%"]})]}),e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"Survey Responses"}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:Number((a==null?void 0:a.surveyResponseCount)||0)})]}),e.jsxs("article",{className:"panel-card-hover",children:[e.jsx("p",{className:"text-xs text-text-secondary",children:"Unread Notifications"}),e.jsx("p",{className:"mt-2 text-2xl font-bold text-text-primary",children:Number((a==null?void 0:a.queueUnread)||0)})]})]}),e.jsxs("section",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs("article",{className:"panel-card",children:[e.jsx("h2",{className:"mb-3 text-base font-semibold text-text-primary",children:"Attendance Trend (Weekly Snapshot)"}),e.jsxs("div",{className:"space-y-2",children:[((t==null?void 0:t.attendanceRateTrends)||[]).slice(0,10).map((s,N)=>e.jsxs("div",{className:"rounded-sm border border-border bg-background p-2 text-xs",children:[e.jsxs("p",{className:"font-semibold text-text-primary",children:[s.studentName||"Student"," | ",s.className||"-"]}),e.jsxs("p",{className:"text-text-secondary",children:["Risk: ",s.riskStatus||"-"," | Attendance: ",s.attendanceRate??"-"]})]},`${s.studentId||N}-${s.className||""}`)),(v=t==null?void 0:t.attendanceRateTrends)!=null&&v.length?null:e.jsx("p",{className:"text-xs text-text-secondary",children:"No weekly trend rows available."})]})]}),e.jsxs("article",{className:"panel-card",children:[e.jsx("h2",{className:"mb-3 text-base font-semibold text-text-primary",children:"Teacher Workload Heatmap"}),e.jsx("div",{className:"space-y-2",children:((t==null?void 0:t.teacherWorkloadHeatmap)||[]).slice(0,12).map(s=>e.jsxs("div",{className:"rounded-sm border border-border bg-background p-2",children:[e.jsxs("div",{className:"mb-1 flex items-center justify-between text-xs",children:[e.jsx("span",{className:"font-semibold text-text-primary",children:s.teacherName}),e.jsxs("span",{className:"text-text-secondary",children:[Number(s.sessions||0)," sessions"]})]}),e.jsx("div",{className:"h-2 rounded-full bg-border",children:e.jsx("div",{className:"h-2 rounded-full bg-primary",style:{width:`${Math.min(100,Number(s.sessions||0)*5)}%`}})})]},s.teacherName))})]})]}),e.jsxs("section",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs("article",{className:"panel-card",children:[e.jsx("h2",{className:"mb-3 text-base font-semibold text-text-primary",children:"Class Capacity Utilization"}),e.jsx("div",{className:"space-y-2",children:((t==null?void 0:t.classCapacityUtilization)||[]).slice(0,20).map(s=>e.jsxs("div",{className:"rounded-sm border border-border bg-background p-2 text-xs",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:s.className}),e.jsxs("p",{className:"text-text-secondary",children:["Enrolled: ",s.enrolled," / ",s.capacity," | Utilization: ",Number(s.utilizationRate||0).toFixed(2),"%"]})]},s.className))})]}),e.jsxs("article",{className:"panel-card",children:[e.jsx("h2",{className:"mb-3 text-base font-semibold text-text-primary",children:"Schedule Conflict Alerts"}),e.jsxs("div",{className:"space-y-2",children:[((t==null?void 0:t.scheduleConflicts)||[]).slice(0,20).map(s=>e.jsxs("div",{className:"rounded-sm border border-danger/40 bg-danger/5 p-2 text-xs",children:[e.jsxs("p",{className:"font-semibold text-text-primary",children:[s.className," | ",s.teacherName]}),e.jsxs("p",{className:"text-text-secondary",children:["Day ",s.dayOfWeek," | ",s.startTime," - ",s.endTime," | Room ",s.room||"-"]}),e.jsxs("p",{className:"text-danger",children:["Conflicts: ",(s.conflictFlags||[]).join(", ")]})]},s.id)),(S=t==null?void 0:t.scheduleConflicts)!=null&&S.length?null:e.jsx("p",{className:"text-xs text-text-secondary",children:"No conflicts detected."})]})]})]})]})]})}export{W as default};
