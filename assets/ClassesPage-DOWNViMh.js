import{a as J,r as t,j as e}from"./index-df1SZI71.js";import{l as K,m as Q,u as X,n as Z}from"./api-x0wxRGLh.js";import{P as _}from"./PageHeading-CUjM0fdU.js";import{u as ee}from"./AdminEnterpriseContext-BE79oEoc.js";const se=(c,p)=>{const d=new Blob([c],{type:"text/csv;charset=utf-8"}),h=window.URL.createObjectURL(d),l=document.createElement("a");l.href=h,l.download=p,document.body.appendChild(l),l.click(),document.body.removeChild(l),window.URL.revokeObjectURL(h)};function le(){var O,U,M,$,G,W,z;const{token:c}=J(),{selectedGrade:p}=ee(),[d,h]=t.useState([]),[l,g]=t.useState(!0),[f,b]=t.useState(!1),[Y,v]=t.useState(!1),[C,n]=t.useState(""),[S,w]=t.useState(""),[y,B]=t.useState(""),[o,k]=t.useState(""),[i,R]=t.useState(""),[a,N]=t.useState(null),[E,P]=t.useState(35),[A,L]=t.useState(""),[T,D]=t.useState(""),F=async()=>{try{g(!0),n("");const s=await K(c);h(s.rows||[])}catch(s){n(s.message||"Failed to load class list."),h([])}finally{g(!1)}};t.useEffect(()=>{F()},[c]),t.useEffect(()=>{p&&!o&&k(p)},[p,o]);const j=t.useMemo(()=>{const s=y.trim().toLowerCase();return d.filter(r=>{const x=!s||String(r.name||"").toLowerCase().includes(s)||String(r.grade||"").toLowerCase().includes(s)||String(r.section||"").toLowerCase().includes(s),u=!o||String(r.grade||"")===o;return x&&u})},[d,y,o]),V=t.useMemo(()=>[...new Set(d.map(s=>String(s.grade||"").trim()).filter(Boolean))].sort(),[d]),I=async s=>{var r,x,u;try{v(!0),R(s);const m=await Q(c,s);N(m),P(Number(((r=m.class)==null?void 0:r.capacity)||35)),L(((x=m.class)==null?void 0:x.section)||""),D(((u=m.class)==null?void 0:u.academicYear)||"")}catch(m){n(m.message||"Failed to load class detail."),N(null)}finally{v(!1)}},H=async()=>{if(i)try{b(!0),n(""),w(""),await X(c,i,{capacity:Number(E||35),section:A,academicYear:T}),w("Class settings updated."),await F(),await I(i)}catch(s){n(s.message||"Failed to update class settings.")}finally{b(!1)}},q=async()=>{var s;if(i)try{b(!0),n("");const r=await Z(c,i),x=((s=a==null?void 0:a.class)==null?void 0:s.name)||"class-roster";se(r,`${x}-roster-${new Date().toISOString().slice(0,10)}.csv`)}catch(r){n(r.message||"Failed to export roster.")}finally{b(!1)}};return e.jsxs("div",{className:"page-enter space-y-5 p-1",children:[e.jsx(_,{title:"Enterprise Class Management",subtitle:"Class roster controls, capacity planning, performance aggregates, and timetable preview."}),C?e.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:C}):null,S?e.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:S}):null,e.jsx("section",{className:"panel-card",children:e.jsxs("div",{className:"grid gap-3 md:grid-cols-3",children:[e.jsx("input",{value:y,onChange:s=>B(s.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Search class by name/grade/section"}),e.jsxs("select",{value:o,onChange:s=>k(s.target.value),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[e.jsx("option",{value:"",children:"All grades"}),V.map(s=>e.jsx("option",{value:s,children:s},s))]}),e.jsxs("p",{className:"rounded-sm border border-border bg-background px-3 py-2 text-sm text-text-secondary",children:[j.length.toLocaleString("en-US")," classes in view"]})]})}),e.jsx("section",{className:"panel-card",children:l?e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-12"}),e.jsx("div",{className:"skeleton h-12"}),e.jsx("div",{className:"skeleton h-12"})]}):e.jsx("div",{className:"overflow-auto",children:e.jsxs("table",{className:"min-w-full border-collapse text-left text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border bg-background",children:[e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Class"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Grade"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Capacity"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Enrolled"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Utilization"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Teacher Count"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Weekly Sessions"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Performance Avg"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Attendance Rate"}),e.jsx("th",{className:"px-3 py-2 text-xs font-semibold text-text-secondary",children:"Detail"})]})}),e.jsx("tbody",{children:j.length?j.map(s=>e.jsxs("tr",{className:"border-b border-border/60",children:[e.jsx("td",{className:"px-3 py-2 text-text-primary",children:s.name}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:s.grade||"-"}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:Number(s.capacity||0)}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:Number(s.enrolled||0)}),e.jsxs("td",{className:"px-3 py-2 text-text-primary",children:[Number(s.utilizationRate||0).toFixed(2),"%"]}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:Number(s.teacherCount||0)}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:Number(s.weeklySessions||0)}),e.jsx("td",{className:"px-3 py-2 text-text-primary",children:Number(s.performanceAverage||0).toFixed(2)}),e.jsxs("td",{className:"px-3 py-2 text-text-primary",children:[Number(s.attendanceRate||0).toFixed(2),"%"]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("button",{type:"button",className:"action-btn",onClick:()=>I(s.id),children:"Open"})})]},s.id)):e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"px-3 py-8 text-center text-text-secondary",children:"No classes found."})})})]})})}),i?e.jsxs("section",{className:"panel-card space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Class Detail Page"}),e.jsx("button",{type:"button",className:"action-btn",onClick:()=>{R(""),N(null)},children:"Close"})]}),Y?e.jsxs("div",{className:"grid gap-2",children:[e.jsx("div",{className:"skeleton h-16"}),e.jsx("div",{className:"skeleton h-16"})]}):a?e.jsxs("div",{className:"grid gap-4 xl:grid-cols-2",children:[e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Class Configuration and Capacity"}),e.jsxs("p",{className:"mt-2 text-xs text-text-secondary",children:[(O=a.class)==null?void 0:O.name," | Grade ",((U=a.class)==null?void 0:U.grade)||"-"," | Section ",((M=a.class)==null?void 0:M.section)||"-"]}),e.jsxs("div",{className:"mt-3 grid gap-2 md:grid-cols-3",children:[e.jsx("input",{type:"number",min:1,value:E,onChange:s=>P(Number(s.target.value||35)),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Capacity"}),e.jsx("input",{value:A,onChange:s=>L(s.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Section"}),e.jsx("input",{value:T,onChange:s=>D(s.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Academic year"})]}),e.jsxs("div",{className:"mt-3 flex flex-wrap gap-2",children:[e.jsx("button",{type:"button",className:"action-btn-primary",onClick:H,disabled:f,children:"Save Capacity Settings"}),e.jsx("button",{type:"button",className:"action-btn",onClick:q,disabled:f,children:"Export Roster"})]})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Class Performance Metrics"}),e.jsxs("div",{className:"mt-2 grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"rounded-sm border border-border p-2",children:["Average performance: ",Number((($=a.classPerformanceMetrics)==null?void 0:$.averagePerformance)||0).toFixed(2)]}),e.jsxs("div",{className:"rounded-sm border border-border p-2",children:["Attendance rate: ",Number(((G=a.classPerformanceMetrics)==null?void 0:G.attendanceRate)||0).toFixed(2),"%"]}),e.jsxs("div",{className:"rounded-sm border border-border p-2",children:["Roster size: ",Number((a.studentRosterPanel||[]).length)]}),e.jsxs("div",{className:"rounded-sm border border-border p-2",children:["Teacher assignments: ",Number((a.teacherAssignmentPanel||[]).length)]})]})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Student Roster Panel"}),e.jsxs("div",{className:"mt-2 max-h-80 overflow-auto space-y-2",children:[(a.studentRosterPanel||[]).map(s=>e.jsxs("div",{className:"rounded-sm border border-border p-2 text-xs",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:s.name}),e.jsx("p",{className:"text-text-secondary",children:s.email}),e.jsxs("p",{className:"text-text-secondary",children:["Lifecycle: ",s.lifecycleState]})]},s.id)),(W=a.studentRosterPanel)!=null&&W.length?null:e.jsx("p",{className:"text-xs text-text-secondary",children:"No students assigned."})]})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Teacher Assignment Panel"}),e.jsxs("div",{className:"mt-2 max-h-80 overflow-auto space-y-2",children:[(a.teacherAssignmentPanel||[]).map(s=>e.jsxs("div",{className:"rounded-sm border border-border p-2 text-xs",children:[e.jsx("p",{className:"font-semibold text-text-primary",children:s.name}),e.jsxs("p",{className:"text-text-secondary",children:["Subject: ",s.subject||"-"]})]},s.id)),(z=a.teacherAssignmentPanel)!=null&&z.length?null:e.jsx("p",{className:"text-xs text-text-secondary",children:"No teachers assigned."})]})]}),e.jsxs("article",{className:"rounded-sm border border-border bg-background p-3 xl:col-span-2",children:[e.jsx("h3",{className:"text-sm font-semibold text-text-primary",children:"Weekly Timetable View"}),e.jsx("div",{className:"mt-2 overflow-auto",children:e.jsxs("table",{className:"min-w-full border-collapse text-left text-xs",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-border",children:[e.jsx("th",{className:"px-2 py-1",children:"Day"}),e.jsx("th",{className:"px-2 py-1",children:"Time"}),e.jsx("th",{className:"px-2 py-1",children:"Subject"}),e.jsx("th",{className:"px-2 py-1",children:"Teacher"}),e.jsx("th",{className:"px-2 py-1",children:"Room"})]})}),e.jsx("tbody",{children:(a.weeklyTimetableView||[]).map(s=>e.jsxs("tr",{className:"border-b border-border/60",children:[e.jsx("td",{className:"px-2 py-1",children:s.dayOfWeek}),e.jsxs("td",{className:"px-2 py-1",children:[s.startTime," - ",s.endTime]}),e.jsx("td",{className:"px-2 py-1",children:s.subject}),e.jsx("td",{className:"px-2 py-1",children:s.teacherName}),e.jsx("td",{className:"px-2 py-1",children:s.room||"-"})]},`${s.dayOfWeek}-${s.startTime}-${s.subject}-${s.teacherName}`))})]})})]})]}):e.jsx("p",{className:"text-sm text-text-secondary",children:"No class detail loaded."})]}):null]})}export{le as default};
