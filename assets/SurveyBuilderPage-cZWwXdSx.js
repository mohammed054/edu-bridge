import{a as V,r as i,j as t}from"./index-df1SZI71.js";import{C as W,D as X,E as Z,F as ee,G as te,H as se,I as ae}from"./api-x0wxRGLh.js";import{P as ne}from"./PageHeading-CUjM0fdU.js";const ie=["multiple_choice","rating","text"],O=()=>({id:`${Date.now()}-${Math.random().toString(16).slice(2,8)}`,type:"multiple_choice",questionText:"",required:!0,options:["",""]}),Q={title:"",description:"",audience:["student"],questions:[O()]},re=(l,y)=>{const g=new Blob([l],{type:"text/csv;charset=utf-8"}),p=window.URL.createObjectURL(g),o=document.createElement("a");o.href=p,o.download=y,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(p)};function oe(){const{token:l}=V(),[y,g]=i.useState([]),[p,o]=i.useState([]),[c,u]=i.useState(Q),[m,k]=i.useState(""),[E,A]=i.useState(!0),[L,x]=i.useState(!1),[D,r]=i.useState(""),[_,b]=i.useState(""),[f,G]=i.useState(""),[$,q]=i.useState(""),[I,R]=i.useState(""),[S,T]=i.useState(""),[P,F]=i.useState(!0),[U,B]=i.useState(!0),d=i.useMemo(()=>p.find(e=>e.id===f)||null,[p,f]),v=async()=>{try{A(!0),r("");const[e,a]=await Promise.all([W(l),X(l)]);g(e.surveys||[]),o(a.rows||[])}catch(e){r(e.message||"Failed to load survey data."),g([]),o([])}finally{A(!1)}};i.useEffect(()=>{v()},[l]),i.useEffect(()=>{d&&(T(d.deadlineAt?d.deadlineAt.slice(0,16):""),q((d.targetGrades||[]).join(", ")),R((d.targetClasses||[]).join(", ")),F(d.autoCloseAtDeadline!==!1),B(d.previewEnabled!==!1))},[d]);const h=(e,a)=>{u(s=>({...s,questions:s.questions.map(n=>n.id===e?{...n,...a}:n)}))},C=()=>{u(Q),k("")},M=async e=>{if(e.preventDefault(),!c.title.trim()){r("Survey title is required.");return}if(!c.questions.length){r("Add at least one question.");return}const a={title:c.title.trim(),description:c.description.trim(),audience:c.audience,questions:c.questions.map((s,n)=>({questionId:`q_${n+1}`,type:s.type,questionText:s.questionText.trim(),required:s.required===!0,options:s.type==="multiple_choice"?(s.options||[]).map(N=>String(N||"").trim()).filter(Boolean):[]}))};try{x(!0),r(""),b(""),m?(await Z(l,m,a),b("Survey updated.")):(await ee(l,a),b("Survey created.")),C(),await v()}catch(s){r(s.message||"Failed to save survey.")}finally{x(!1)}},H=e=>{r(""),b(""),k(e.id),u({title:e.title||e.name||"",description:e.description||"",audience:Array.isArray(e.audience)&&e.audience.length?e.audience:["student"],questions:(e.questions||[]).map(a=>({id:a.questionId||`${Date.now()}-${Math.random()}`,type:a.type||"text",questionText:a.questionText||a.prompt||"",required:a.required===!0,options:a.type==="multiple_choice"?a.options||["",""]:[]}))})},z=async e=>{if(window.confirm(`Delete survey "${e.title||e.name}"?`))try{x(!0),r(""),await te(l,e.id),b("Survey deleted."),m===e.id&&C(),await v()}catch(a){r(a.message||"Failed to delete survey.")}finally{x(!1)}},j=async(e,a,s)=>{try{x(!0),r(""),await se(l,e,a),b(s||"Survey lifecycle updated."),await v()}catch(n){r(n.message||"Failed to update survey lifecycle.")}finally{x(!1)}},Y=async()=>{if(!f){r("Select a survey lifecycle row first.");return}await j(f,{deadlineAt:S?new Date(S).toISOString():null,autoCloseAtDeadline:P,previewEnabled:U,targetGrades:$.split(",").map(e=>e.trim()).filter(Boolean),targetClasses:I.split(",").map(e=>e.trim()).filter(Boolean)},"Lifecycle settings updated.")},J=async(e,a)=>{try{r("");const s=await ae(l,e),n=String(a||"survey").replace(/[^a-z0-9-_]/gi,"-").toLowerCase();re(s,`${n}-raw-${new Date().toISOString().slice(0,10)}.csv`)}catch(s){r(s.message||"Failed to export raw survey data.")}};return t.jsxs("div",{className:"page-enter space-y-5 p-1",children:[t.jsx(ne,{title:"Survey Builder and Lifecycle",subtitle:"Builder + publish lifecycle, targeting, participation metrics, and raw response exports."}),D?t.jsx("p",{className:"rounded-sm border border-danger/25 bg-danger/5 px-3 py-2 text-sm text-danger",children:D}):null,_?t.jsx("p",{className:"rounded-sm border border-success/25 bg-success/10 px-3 py-2 text-sm text-success",children:_}):null,t.jsxs("section",{className:"panel-card space-y-4",children:[t.jsx("h2",{className:"text-base font-semibold text-text-primary",children:m?"Edit Survey":"Create Survey"}),t.jsxs("form",{className:"space-y-3",onSubmit:M,children:[t.jsxs("div",{className:"grid gap-3 md:grid-cols-2",children:[t.jsx("input",{value:c.title,onChange:e=>u(a=>({...a,title:e.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Survey title"}),t.jsx("input",{value:c.description,onChange:e=>u(a=>({...a,description:e.target.value})),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Description"})]}),t.jsx("div",{className:"flex flex-wrap gap-2",children:["student","teacher"].map(e=>{const a=c.audience.includes(e);return t.jsx("button",{type:"button",className:`action-btn rounded-full px-3 py-1 text-xs ${a?"border-transparent bg-primary text-white":""}`,onClick:()=>u(s=>({...s,audience:a?s.audience.filter(n=>n!==e):[...s.audience,e]})),children:e},e)})}),t.jsx("div",{className:"space-y-3",children:c.questions.map((e,a)=>t.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[t.jsxs("div",{className:"mb-2 flex items-center justify-between",children:[t.jsxs("p",{className:"text-sm font-semibold text-text-primary",children:["Question ",a+1]}),t.jsx("button",{type:"button",className:"action-btn",onClick:()=>u(s=>({...s,questions:s.questions.length<=1?s.questions:s.questions.filter(n=>n.id!==e.id)})),children:"Delete"})]}),t.jsxs("div",{className:"grid gap-2 md:grid-cols-[1fr_180px_auto]",children:[t.jsx("input",{value:e.questionText,onChange:s=>h(e.id,{questionText:s.target.value}),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Question text"}),t.jsx("select",{value:e.type,onChange:s=>h(e.id,{type:s.target.value,options:s.target.value==="multiple_choice"?["",""]:[]}),className:"focus-ring rounded-sm border border-border bg-white px-3 py-2 text-sm",children:ie.map(s=>t.jsx("option",{value:s,children:s},`${e.id}-${s}`))}),t.jsxs("label",{className:"inline-flex items-center gap-2 rounded-sm border border-border bg-white px-3 py-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:e.required,onChange:s=>h(e.id,{required:s.target.checked})}),"Required"]})]}),e.type==="multiple_choice"?t.jsxs("div",{className:"mt-2 space-y-2",children:[(e.options||[]).map((s,n)=>t.jsxs("div",{className:"flex gap-2",children:[t.jsx("input",{value:s,onChange:N=>h(e.id,{options:(e.options||[]).map((w,K)=>K===n?N.target.value:w)}),className:"focus-ring w-full rounded-sm border border-border px-3 py-2 text-sm",placeholder:`Option ${n+1}`}),t.jsx("button",{type:"button",className:"action-btn",onClick:()=>h(e.id,{options:(e.options||[]).length<=2?e.options:e.options.filter((N,w)=>w!==n)}),children:"Delete"})]},`${e.id}-option-${n}`)),t.jsx("button",{type:"button",className:"action-btn",onClick:()=>h(e.id,{options:[...e.options||[],""]}),children:"Add option"})]}):null]},e.id))}),t.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.jsx("button",{type:"button",className:"action-btn",onClick:()=>u(e=>({...e,questions:[...e.questions,O()]})),children:"Add Question"}),t.jsx("button",{type:"submit",className:"action-btn-primary",disabled:L,children:m?"Update Survey":"Create Survey"}),m?t.jsx("button",{type:"button",className:"action-btn",onClick:C,children:"Cancel Edit"}):null]})]})]}),t.jsxs("section",{className:"panel-card",children:[t.jsx("h2",{className:"mb-3 text-base font-semibold text-text-primary",children:"Surveys"}),E?t.jsxs("div",{className:"grid gap-2",children:[t.jsx("div",{className:"skeleton h-12"}),t.jsx("div",{className:"skeleton h-12"})]}):t.jsxs("div",{className:"space-y-2",children:[y.map(e=>t.jsx("article",{className:"rounded-sm border border-border bg-background p-3",children:t.jsxs("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-text-primary",children:e.title||e.name}),t.jsxs("p",{className:"text-xs text-text-secondary",children:["Questions: ",(e.questions||[]).length," | Responses: ",Number(e.totalResponses||0)]})]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx("button",{type:"button",className:"action-btn",onClick:()=>H(e),children:"Edit"}),t.jsx("button",{type:"button",className:"action-btn",onClick:()=>z(e),children:"Delete"})]})]})},e.id)),y.length?null:t.jsx("p",{className:"text-sm text-text-secondary",children:"No surveys found."})]})]}),t.jsxs("section",{className:"panel-card space-y-3",children:[t.jsx("h2",{className:"text-base font-semibold text-text-primary",children:"Survey Lifecycle Console"}),E?t.jsxs("div",{className:"grid gap-2",children:[t.jsx("div",{className:"skeleton h-12"}),t.jsx("div",{className:"skeleton h-12"})]}):t.jsxs("div",{className:"space-y-2",children:[(p||[]).map(e=>t.jsx("article",{className:"rounded-sm border border-border bg-background p-3",children:t.jsxs("div",{className:"grid gap-2 lg:grid-cols-[1fr_auto_auto_auto_auto_auto]",children:[t.jsxs("div",{children:[t.jsx("p",{className:"text-sm font-semibold text-text-primary",children:e.title}),t.jsxs("p",{className:"text-xs text-text-secondary",children:["status: ",e.publishStatus," | responses: ",Number(e.responses||0)," | audience: ",(e.audience||[]).join(", ")||"-"]}),t.jsxs("p",{className:"text-xs text-text-secondary",children:["deadline: ",e.deadlineAt?new Date(e.deadlineAt).toLocaleString("en-US"):"-"]})]}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>G(e.id),children:"Configure"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>j(e.id,{action:"publish"},"Survey published."),children:"Publish"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>j(e.id,{action:"unpublish"},"Survey unpublished."),children:"Unpublish"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>j(e.id,{action:"close"},"Survey closed."),children:"Close"}),t.jsx("button",{type:"button",className:"action-btn px-2 py-1 text-[11px]",onClick:()=>J(e.id,e.title),children:"Export Raw"})]})},e.id)),p.length?null:t.jsx("p",{className:"text-sm text-text-secondary",children:"No lifecycle rows found."})]}),d?t.jsxs("article",{className:"rounded-sm border border-border bg-background p-3",children:[t.jsxs("h3",{className:"text-sm font-semibold text-text-primary",children:["Lifecycle Settings for ",d.title]}),t.jsxs("div",{className:"mt-3 grid gap-3 md:grid-cols-2",children:[t.jsx("input",{type:"datetime-local",value:S,onChange:e=>T(e.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm"}),t.jsx("input",{value:$,onChange:e=>q(e.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Target grades (comma separated)"}),t.jsx("input",{value:I,onChange:e=>R(e.target.value),className:"focus-ring rounded-sm border border-border px-3 py-2 text-sm",placeholder:"Target classes (comma separated)"}),t.jsxs("div",{className:"flex flex-wrap gap-4",children:[t.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:P,onChange:e=>F(e.target.checked)}),"Auto close at deadline"]}),t.jsxs("label",{className:"inline-flex items-center gap-2 text-sm",children:[t.jsx("input",{type:"checkbox",checked:U,onChange:e=>B(e.target.checked)}),"Preview enabled"]})]})]}),t.jsx("button",{type:"button",className:"action-btn-primary mt-3",onClick:Y,disabled:L,children:"Save Lifecycle Settings"})]}):null]})]})}export{oe as default};
